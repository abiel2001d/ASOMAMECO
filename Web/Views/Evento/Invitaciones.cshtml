@model Infraestructura.Model.Evento
@{
    ViewBag.Title = "Invitaciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var invitaciones = ViewBag.Invitaciones as IEnumerable<Infraestructura.Model.Invitacion>;
}

<div class="container">
    <p class="mt-3">
        <button class="btn btn-primary" id="send-invitation-button" style="@(invitaciones.Any() ? "display:none;" : "")">Enviar Invitaciones</button>
        <div id="spinner-container" style="display: none;">
            <div id="spinner" class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <span id="sending-text">Enviando Invitaciones</span>
        </div>
    </p>
    <div class="card mb-3">
        <div class="card-header">
            <h5>Evento: @Model.Nombre_Evento</h5>
        </div>
        <div class="card-body">
            <p><strong>Fecha & Hora:</strong> @Model.Fecha_Evento.ToString("dd/MMMM/yyyy hh:mm tt")</p>
            <p><strong>Lugar:</strong> @Model.Lugar</p>
            <p><strong>Descripción:</strong> @Model.Descripcion</p>
        </div>
    </div>

    <!-- Button to return to Evento Index -->
    <div class="mb-3">
        <a href="@Url.Action("Index", "Evento")" class="btn btn-secondary">Volver a Eventos</a>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            <h5>Lista de invitaciones</h5>
        </div>
        <div class="card-body">
            <!-- Search Inputs -->
            <div class="row mb-3">

                <div class="col-md-4">
                    <input type="text" id="search-cedula" class="form-control" placeholder="Buscar por Cédula">
                </div>
                <div class="col-md-4">
                    <input type="text" id="search-nombre" class="form-control" placeholder="Buscar por Nombre">
                </div>
                <div class="col-md-4">
                    <select id="search-estado" class="form-control">
                        <option value="">Todos</option>
                        <option value="Enviado sin respuesta aún">Sin Respuesta</option>
                        <option value="No Asistirá">No Asistirá</option>
                        <option value="Sí Asistirá">Sí Asistirá</option>
                    </select>
                </div>
            </div>

            <table class="table table-hover table-sm">
                <thead class="thead-light">
                    <tr>
                        <th>Cédula</th>
                        <th>Nombre</th>
                        <th>Correo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="invitaciones-table-body">
                    @if (invitaciones.Any())
                    {
                        foreach (var invitacion in invitaciones)
                        {
                            <tr>
                                <td>@invitacion.Usuario.Cedula</td>
                                <td>@invitacion.Usuario.Nombre</td>
                                <td>@invitacion.Usuario.Correo</td>
                                <td>
                                    <span class="status-box @(invitacion.Confirmado == "Enviado sin respuesta aún" ? "status-gray" : invitacion.Confirmado == "No Asistirá" ? "status-red" : "status-green")">
                                        @invitacion.Confirmado
                                    </span>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4">No hay invitaciones enviadas aún.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.getElementById("send-invitation-button").addEventListener("click", function() {
        var button = this;
        var spinnerContainer = document.getElementById("spinner-container");
        button.style.display = "none";
        spinnerContainer.style.display = "inline-block";

        var eventId = @Model.ID_Evento;
        $.ajax({
            url: '@Url.Action("EnviarInvitaciones", "Evento")/' + eventId,
            type: 'POST',
            success: function(result) {
                spinnerContainer.style.display = "none";
                if (result.success) {
                    swal({ title: '', text: '¡Invitaciones enviadas con éxito!', type: 'success', customClass: 'swal-custom' });
                    updateTable(result.invitaciones);
                } else {
                    swal({ title: '', text: result.message, type: 'error', customClass: 'swal-custom' });
                    button.style.display = "inline-block";
                }
            },
            error: function() {
                spinnerContainer.style.display = "none";
                swal({ title: '', text: 'Error al enviar invitaciones', type: 'error', customClass: 'swal-custom' });
                button.style.display = "inline-block";
            }
        });
    });

    document.getElementById('search-nombre').addEventListener('input', filterTable);
    document.getElementById('search-cedula').addEventListener('input', filterTable);
    document.getElementById('search-estado').addEventListener('change', filterTable);

    function filterTable() {
        var nombreInput = document.getElementById('search-nombre').value.toLowerCase();
        var cedulaInput = document.getElementById('search-cedula').value.toLowerCase();
        var estadoInput = document.getElementById('search-estado').value;

        var rows = document.querySelectorAll('#invitaciones-table-body tr');

        rows.forEach(function(row) {
            var nombre = row.children[1].textContent.toLowerCase();
            var cedula = row.children[0].textContent.toLowerCase();
            var estado = row.children[3].textContent.trim();

            var nombreMatch = nombre.includes(nombreInput);
            var cedulaMatch = cedula.includes(cedulaInput);
            var estadoMatch = (estadoInput === "" || estado === estadoInput);

            if (nombreMatch && cedulaMatch && estadoMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function updateTable(invitaciones) {
        var tbody = document.getElementById("invitaciones-table-body");
        tbody.innerHTML = "";

        if (invitaciones.length === 0) {
            tbody.innerHTML = "<tr><td colspan='4'>No hay invitaciones enviadas aún.</td></tr>";
            document.getElementById("send-invitation-button").style.display = "inline-block";
        } else {
            invitaciones.forEach(function(invitacion) {
                var row = "<tr>";
                row += "<td>" + invitacion.Cedula + "</td>";
                row += "<td>" + invitacion.Nombre + "</td>";
                row += "<td>" + invitacion.Correo + "</td>";
                row += "<td><span class='status-box " + (invitacion.Confirmado == "Enviado sin respuesta aún" ? "status-gray" : invitacion.Confirmado == "No asistirá" ? "status-red" : "status-green") + "'>" + invitacion.Confirmado + "</span></td>";
                row += "</tr>";
                tbody.innerHTML += row;
            });

            document.getElementById("send-invitation-button").style.display = "none";
        }
    }
</script>

<style>
    .table-sm {
        font-size: 0.875rem;
    }

    .status-box {
        display: inline-block;
        padding: 0.2em 0.6em;
        border-radius: 0.25em;
        color: white;
    }

    .status-gray {
        background-color: gray;
    }

    .status-red {
        background-color: crimson;
    }

    .status-green {
        background-color: mediumseagreen;
    }

    .card-body p {
        margin: 5px 0;
    }

    .text-center {
        text-align: center;
    }

    .spinner-border {
        width: 2rem;
        height: 2rem;
        border-width: 2px;
    }

    #sending-text {
        margin-left: 0.6rem;
        padding-bottom: 0.8rem;
        font-size: 1rem;
        vertical-align: middle;
        color: grey
    }
</style>
